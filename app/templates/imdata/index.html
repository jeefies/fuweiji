{% extends "code-base.html" %}

{% block title %}imdata{% endblock %}

{% block script %}
{{ super() }}
<script src="https://cdn.bootcdn.net/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
{% endblock %}

{% block style %}
<style type="text/css" media="all">
.file-input {
   	padding: 4px 10px;
	height: 20px;
	line-height: 20px;
	position: relative;
	cursor: pointer;
	color: #888;
	background: #fafafa;
	border: 1px solid #ddd;
	border-radius: 4px;
	overflow: hidden;
	display: inline-block;
	*display: inline;
	*zoom: 1
}
	
.file-input input {
	position: absolute;
	font-size: 100px;
	right: 0;
	top: 0;
	opacity: 0;
   	filter: alpha(opacity=0);
	cursor: pointer
}
	
.file-input:hover {
	color: #444;
	background: #eee;
	border-color: #ccc;
	text-decoration: none
}

#uploadFileNameField {
   	padding: 4px 10px;
	height: 20px;
	line-height: 20px;
	position: relative;
	color: #888;
	display: inline-block;
	/* the most imp line */
	overflow: hidden;
}
</style>
{% endblock %}

{% block main %}
	<h1 class="layui-font-green">ImData线上api</h1>

	<fieldset class="layui-elem-field layui-field-title">
		<legend>加密数据</legend>
	</fieldset>

	<div class="layui-form" action='' method="post" id="mainForm">
		<div class="layui-form-item">
			<label class="layui-form-label">数据类型</label>
			<div class="layui-input-block">
				<input type="radio" name="method" value=1 title="压缩数据" checked />
				<input type="radio" name="method" value=2 title="Chencode集成" />
				<!--
				<input class="layui-input" type="radio" name="method" value=1 title="压缩数据" checked />
				<input class="layui-input" type="radio" name="method" value=2 title="Chencode集成" />
				-->
			</div>
		</div>

		<div class="layui-form-item layui-form-text">
			<label class="layui-form-label">数据</label>
			<div class="layui-input-block">
				<textarea class="layui-textarea" name="ctx" rows="10" placeholder="请在这里输入内容哦^_^"></textarea>
			</div>
		</div>

		<div class="layui-form-item">
			<label class="layui-form-label">文件</label>
			<div class="layui-input-block">
				<div class="file-input">
					<input class="layui-input" type="file" name="file" value="上传文件" id="upFile">
					上传文件
					</input>
				</div>
				<div id="uploadFileNameField"></div>
			</div>
			<blockquote class="layui-elem-quote layui-quote-nm">
				上传了文件，就不会使用输入的数据了！
			</blockquote>
		</div>

		<div class="layui-form-item">
			<div class="layui-input-block">
				<button type="submit" class="layui-btn" lay-submit lay-filter="form">获取加密图像</button>
				<button type="reset" class="layui-btn layui-btn-primary" id="resetBtn">重置</button>
			</div>
		</div>
	</div> <!-- layui-form end -->
{% endblock %}

{% block lastscript %}

function download(result) {
	let blob = new Blob([result]);
	let a = document.createElement("a");
	document.body.appendChild(a);
	a.href = URL.createObjectURL(blob);
	a.download = 'data.bmp';
	a.click();
	document.body.removeChild(a);
}

function send_data(data) {
	let field = data.field;
	let filedata = $("#upFile");
	let upd = { 'method' : field['method'] };

	// upd.append('method', field['method']);
	if (field['file'] == null) {
		// upd.append("ctx", field['ctx']);
		upd['ctx'] = field['ctx']
		$.post('/imdata/encode', upd, download);
	} else {
		// upd.append("file", filedata.prop("files")[0]);
		let f = filedata.prop("files")[0];
		
		let reader = new FileReader();
		reader.readAsBinaryString(f);
		reader.onload = function(e) {
			upd['file'] = reader.result;
			$.post('/imdata/encode', upd, download);
		}
	}

}

$("#upFile").bind("change", function() {
	let name = $("#upFile").prop("files")[0].name;
	$("#uploadFileNameField").html(name);
} )

layui.use(["form", "element"], function() {
	let element = layui.element;
	element.on('nav(demo)', function(elem){
		layer.msg(elem.text());
	});

	let form = layui.form;
	form.on("submit(form)", function(data) {
		send_data(data);
		$("resetBtn").click();
		return false;
	})
})
{% endblock lastscript %}
